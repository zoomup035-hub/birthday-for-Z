<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishes for ZaarGull</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;400;600&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(circle at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            height: 100vh;
            transition: background 2s ease;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.6;
        }

        .stream-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            scroll-behavior: smooth;
            perspective: 1200px;
        }

        .stream-container::-webkit-scrollbar {
            width: 5px;
        }

        .stream-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .stream-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1));
            border-radius: 10px;
        }

        /* === WISH CARDS === */
        .wish-item {
            max-width: 700px;
            margin: 0 auto 100px;
            padding: 50px;
            position: relative;
            opacity: 0;
            transform: translateY(60px) scale(0.92) rotateX(5deg);
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 28px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.9s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
        }

        .wish-item::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 30px;
            background: conic-gradient(from var(--border-angle, 0deg), transparent 60%, var(--wish-color) 80%, transparent 100%);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.6s ease;
            animation: rotateBorder 4s linear infinite;
        }

        @keyframes rotateBorder {
            to {
                --border-angle: 360deg;
            }
        }

        @property --border-angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        .wish-item.visible {
            opacity: 1;
            transform: translateY(0) scale(1) rotateX(0deg);
        }

        .wish-item.visible::before {
            opacity: 0.5;
        }

        .wish-item:hover {
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35), 0 0 30px var(--wish-color), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-4px) scale(1.01);
        }

        .wish-number {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.7rem;
            letter-spacing: 0.5em;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 25px;
            background: var(--wish-color);
            color: #000;
            padding: 6px 16px;
            border-radius: 50px;
            box-shadow: 0 0 15px color-mix(in srgb, var(--wish-color) 40%, transparent);
        }

        .wish-text {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            line-height: 1.7;
            color: #f0f0f0;
            font-weight: 300;
            min-height: 60px;
            text-shadow: 0 2px 15px rgba(0, 0, 0, 0.4);
            font-family: 'Dancing Script', cursive;
        }

        .wish-text.typing::after {
            content: '|';
            animation: blink 0.8s infinite;
            color: var(--wish-color, #fff);
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .wish-author {
            margin-top: 35px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
            text-align: right;
            font-family: 'Playfair Display', serif;
            font-style: italic;
            opacity: 0;
            transform: translateX(-15px);
            transition: all 0.6s ease 0.5s;
        }

        .wish-item.visible .wish-author {
            opacity: 1;
            transform: translateX(0);
        }

        .reaction-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 12px;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .reaction-btn:hover {
            transform: scale(1.15);
            border-color: var(--wish-color);
        }

        .reaction-btn.liked {
            background: var(--wish-color);
            border-color: var(--wish-color);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 25px var(--wish-color);
            animation: likedPop 0.4s ease;
        }

        @keyframes likedPop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.3)
            }

            100% {
                transform: scale(1)
            }
        }

        /* === START SCREEN === */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at 50% 50%, #1a1a2e 0%, #0a0a1a 70%, #000 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1.5s ease, visibility 1.5s;
            overflow: hidden;
        }

        .start-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .sparkle {
            position: absolute;
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: #fff;
            opacity: 0;
            animation: sparkleFloat 3s ease-in-out infinite;
        }

        @keyframes sparkleFloat {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0);
            }

            50% {
                opacity: 0.8;
                transform: translateY(-50px) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0);
            }
        }

        .start-glow {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(165, 180, 252, 0.15) 0%, transparent 70%);
            animation: breatheGlow 4s ease-in-out infinite;
        }

        @keyframes breatheGlow {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        .start-screen h1 {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(3.5rem, 10vw, 6rem);
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #c4b5fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
            filter: drop-shadow(0 0 30px rgba(165, 180, 252, 0.4));
        }

        .start-screen p {
            font-size: 1rem;
            letter-spacing: 0.4em;
            color: #a5b4fc;
            text-transform: uppercase;
            margin-bottom: 50px;
            z-index: 2;
            font-family: 'Playfair Display', serif;
        }

        .start-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.35);
            color: #fff;
            padding: 18px 55px;
            font-size: 1rem;
            letter-spacing: 0.25em;
            cursor: pointer;
            border-radius: 50px;
            transition: 0.5s;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            z-index: 2;
        }

        .start-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            animation: shimmerBtn 3s ease-in-out infinite;
        }

        @keyframes shimmerBtn {
            0% {
                left: -100%
            }

            100% {
                left: 200%
            }
        }

        .start-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            color: #111;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.3), 0 0 80px rgba(165, 180, 252, 0.2);
        }

        /* === TOP CONTROLS === */
        .top-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .music-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.25);
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .music-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        .music-btn.playing {
            border-color: #4ade80;
            color: #4ade80;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.3);
        }

        .eq-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 14px;
        }

        .eq-bar {
            width: 3px;
            background: #4ade80;
            border-radius: 2px;
            animation: eqBounce 0.6s ease-in-out infinite alternate;
        }

        .eq-bar:nth-child(1) {
            height: 6px;
            animation-delay: 0s;
        }

        .eq-bar:nth-child(2) {
            height: 10px;
            animation-delay: 0.15s;
        }

        .eq-bar:nth-child(3) {
            height: 4px;
            animation-delay: 0.3s;
        }

        @keyframes eqBounce {
            to {
                height: 14px;
            }
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--current-color, #fff), color-mix(in srgb, var(--current-color, #fff) 50%, #fff));
            z-index: 50;
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 15px var(--current-color);
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6));
            animation: shimmerProg 2s ease-in-out infinite;
        }

        @keyframes shimmerProg {

            0%,
            100% {
                opacity: 0.3
            }

            50% {
                opacity: 1
            }
        }

        #treeCanvas {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            pointer-events: none;
            filter: drop-shadow(0 0 25px rgba(0, 0, 0, 0.6));
        }

        .float-heart {
            position: fixed;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 60;
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1) rotate(0deg);
            }

            100% {
                opacity: 0;
                transform: translateY(-120px) scale(0.3) rotate(45deg);
            }
        }

        .confetti-piece {
            position: fixed;
            width: 8px;
            height: 14px;
            z-index: 1000;
            pointer-events: none;
            animation: confettiFall 3s ease-in forwards;
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(-20px) rotateZ(0deg) rotateX(0deg);
            }

            100% {
                opacity: 0;
                transform: translateY(100vh) rotateZ(720deg) rotateX(360deg);
            }
        }

        .end-message {
            text-align: center;
            padding: 200px 20px 400px;
            opacity: 0;
            transform: translateY(30px);
        }

        .end-message.visible {
            opacity: 1;
            transform: translateY(0);
            transition: 1.2s;
        }

        .end-title {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(2.5rem, 8vw, 4rem);
            background: linear-gradient(135deg, #ffd700 0%, #fff8dc 30%, #ffd700 50%, #fff8dc 70%, #ffd700 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmerGold 3s linear infinite;
            margin-bottom: 1.5rem;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.4));
        }

        @keyframes shimmerGold {
            0% {
                background-position: 200% 50%
            }

            100% {
                background-position: -200% 50%
            }
        }

        .end-subtitle {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .end-card-border {
            display: inline-block;
            padding: 50px 40px;
            border-radius: 28px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
            animation: pulseGold 3s ease-in-out infinite;
        }

        @keyframes pulseGold {

            0%,
            100% {
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
                border-color: rgba(255, 215, 0, 0.3);
            }

            50% {
                box-shadow: 0 0 50px rgba(255, 215, 0, 0.25);
                border-color: rgba(255, 215, 0, 0.6);
            }
        }

        .fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        @media (max-width: 768px) {
            .wish-item {
                max-width: 92%;
                padding: 30px 22px;
                margin-bottom: 80px;
            }

            .wish-text {
                font-size: clamp(1.1rem, 5vw, 1.4rem);
            }

            #treeCanvas {
                transform: translateX(-50%) scale(0.8);
                bottom: -50px;
            }

            .start-screen h1 {
                font-size: 3rem;
            }

            .start-btn {
                padding: 15px 40px;
                font-size: 0.9rem;
            }

            .start-glow {
                width: 250px;
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            #treeCanvas {
                transform: translateX(-50%) scale(0.6);
                bottom: -80px;
                opacity: 0.5;
            }

            .wish-item {
                backdrop-filter: blur(25px);
                background: rgba(15, 15, 35, 0.88);
                padding: 25px 18px;
            }

            .reaction-btn {
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }
        }

        /* === GO BACK BUTTON === */
        .go-back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(10, 15, 20, 0.8);
            border: 1px solid #3fefef;
            color: #3fefef;
            text-decoration: none;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            border-radius: 5px;
            z-index: 9999;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            backdrop-filter: blur(5px);
            opacity: 0;
            pointer-events: none;
            animation: delayedFadeIn 2s ease forwards;
            animation-delay: 8s;
            /* Appears after 8 seconds */
        }

        @keyframes delayedFadeIn {
            to {
                opacity: 1;
                pointer-events: auto;
            }
        }

        .go-back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--wish-color, #4ade80);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <!-- Go Back Button -->
    <a href="birthday_page.html?skip=true&completed=message_world" class="go-back-btn">
        ‚Üê RETURN TO MISSION
    </a>

    <audio id="bgMusic" loop>
        <source src="https://assets.mixkit.co/music/preview/mixkit-happy-birthday-to-you-552.mp3" type="audio/mpeg">
    </audio>

    <div id="canvas-container"></div>
    <canvas class="fireworks-canvas" id="fireworksCanvas"></canvas>
    <div class="progress-bar" id="progressBar"></div>

    <div class="top-controls">
        <button class="music-btn" id="musicBtn" onclick="toggleMusic()" title="Toggle Music">‚ô´</button>
    </div>

    <canvas id="treeCanvas"></canvas>

    <div class="start-screen" id="startScreen">
        <div class="start-glow"></div>
        <h1>Wishes for ZaarGull</h1>
        <p>Turn on volume & relax</p>
        <button class="start-btn" onclick="startExperience()">Open Gift</button>
    </div>

    <div class="stream-container" id="streamContainer"></div>

    <script>
        // === Generate sparkles on start screen ===
        (function () {
            const screen = document.getElementById('startScreen');
            for (let i = 0; i < 40; i++) {
                const s = document.createElement('div');
                s.className = 'sparkle';
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                s.style.animationDelay = (Math.random() * 4) + 's';
                s.style.animationDuration = (2 + Math.random() * 2) + 's';
                s.style.width = s.style.height = (2 + Math.random() * 3) + 'px';
                screen.appendChild(s);
            }
        })();

        // === 1. Three.js Background ===
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Stars
        const starsGeometry = new THREE.BufferGeometry();
        const starsCount = 1200;
        const posArray = new Float32Array(starsCount * 3);
        const sizeArray = new Float32Array(starsCount);
        for (let i = 0; i < starsCount; i++) {
            posArray[i * 3] = (Math.random() - 0.5) * 120;
            posArray[i * 3 + 1] = (Math.random() - 0.5) * 120;
            posArray[i * 3 + 2] = (Math.random() - 0.5) * 80;
            sizeArray[i] = Math.random() * 2;
        }
        starsGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        starsGeometry.setAttribute('size', new THREE.BufferAttribute(sizeArray, 1));
        const starsMaterial = new THREE.PointsMaterial({ size: 0.12, color: 0xffffff, transparent: true, opacity: 0.85 });
        const starsMesh = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(starsMesh);

        // Nebula color clouds
        const nebulaGroup = new THREE.Group();
        const nebulaColors = [0x7c3aed, 0x6366f1, 0xec4899, 0x3b82f6];
        nebulaColors.forEach((col, i) => {
            const nGeo = new THREE.BufferGeometry();
            const nCount = 100;
            const nPos = new Float32Array(nCount * 3);
            const cx = (Math.random() - 0.5) * 40;
            const cy = (Math.random() - 0.5) * 40;
            for (let j = 0; j < nCount * 3; j += 3) {
                nPos[j] = cx + (Math.random() - 0.5) * 25;
                nPos[j + 1] = cy + (Math.random() - 0.5) * 25;
                nPos[j + 2] = -30 - Math.random() * 20;
            }
            nGeo.setAttribute('position', new THREE.BufferAttribute(nPos, 3));
            const nMat = new THREE.PointsMaterial({ size: 1.5, color: col, transparent: true, opacity: 0.08 });
            nebulaGroup.add(new THREE.Points(nGeo, nMat));
        });
        scene.add(nebulaGroup);

        // Floating Hearts
        const heartsGroup = new THREE.Group();
        const heartShape = new THREE.Shape();
        heartShape.moveTo(0, 0);
        heartShape.bezierCurveTo(0, 0, -0.3, 0.5, -0.9, 0.5);
        heartShape.bezierCurveTo(-1.8, 0.5, -1.8, -0.8, -1.8, -0.8);
        heartShape.bezierCurveTo(-1.8, -1.4, -0.6, -2.2, 0, -3);
        heartShape.bezierCurveTo(0.6, -2.2, 1.8, -1.4, 1.8, -0.8);
        heartShape.bezierCurveTo(1.8, -0.8, 1.8, 0.5, 0.9, 0.5);
        heartShape.bezierCurveTo(0.3, 0.5, 0, 0, 0, 0);
        const heartGeo = new THREE.ShapeGeometry(heartShape);
        const heartColors = [0xff6b6b, 0xff9ff3, 0xf368e0, 0xff6348];
        for (let i = 0; i < 18; i++) {
            const hMat = new THREE.MeshBasicMaterial({
                color: heartColors[i % heartColors.length],
                transparent: true, opacity: 0.3 + Math.random() * 0.2, side: THREE.DoubleSide
            });
            const heart = new THREE.Mesh(heartGeo, hMat);
            heart.position.set((Math.random() - 0.5) * 70, (Math.random() - 0.5) * 70, (Math.random() - 0.5) * 40);
            heart.scale.setScalar(0.15 + Math.random() * 0.12);
            heart.rotation.z = Math.PI;
            heart.userData = { speed: 0.015 + Math.random() * 0.04, wobble: Math.random() * Math.PI * 2 };
            heartsGroup.add(heart);
        }
        scene.add(heartsGroup);

        // Shooting Stars
        const shootingStars = [];
        function createShootingStar() {
            const geo = new THREE.BufferGeometry();
            const pts = [];
            for (let i = 0; i < 20; i++) pts.push((i / 20) * 8, 0, 0);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
            const mat = new THREE.PointsMaterial({ size: 0.08, color: 0xffffff, transparent: true, opacity: 0.9 });
            const star = new THREE.Points(geo, mat);
            star.position.set((Math.random() - 0.5) * 80, 30 + Math.random() * 20, -20);
            star.userData = { vx: -(3 + Math.random() * 3), vy: -(2 + Math.random() * 2), life: 1 };
            scene.add(star);
            shootingStars.push(star);
        }

        camera.position.z = 30;

        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth / 2) * 0.001;
            mouseY = (e.clientY - window.innerHeight / 2) * 0.001;
        });

        function animate() {
            requestAnimationFrame(animate);
            starsMesh.rotation.y += 0.0004;
            starsMesh.rotation.x += 0.0001;
            nebulaGroup.rotation.y += 0.0002;
            nebulaGroup.rotation.x += 0.0001;

            heartsGroup.children.forEach(heart => {
                heart.position.y += heart.userData.speed;
                heart.rotation.y = Math.sin(Date.now() * 0.001 + heart.userData.wobble) * 0.5;
                heart.rotation.x = Math.cos(Date.now() * 0.0008 + heart.userData.wobble) * 0.15;
                if (heart.position.y > 35) heart.position.y = -35;
            });

            // Shooting stars
            if (Math.random() < 0.003) createShootingStar();
            shootingStars.forEach((s, i) => {
                s.position.x += s.userData.vx * 0.3;
                s.position.y += s.userData.vy * 0.3;
                s.userData.life -= 0.015;
                s.material.opacity = s.userData.life;
                if (s.userData.life <= 0) { scene.remove(s); shootingStars.splice(i, 1); }
            });

            camera.position.x += (mouseX * 5 - camera.position.x) * 0.04;
            camera.position.y += (-mouseY * 5 - camera.position.y) * 0.04;
            camera.lookAt(scene.position);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // === 2. Application Logic ===
        const wishColors = ['#ff9ff3', '#feca57', '#ff6b6b', '#48dbfb', '#1dd1a1', '#a29bfe', '#54a0ff', '#5f27cd'];
        const wishes = [
            "Dearest ZaarGull, may your smile never fade and your heart always remain as beautiful as it is today.",
            "Here's to another year of creating memories that will last a lifetime. Happy Birthday!",
            "Wishing you success in everything you dream of and pure happiness in everything you do.",
            "May every day bring you new reasons to celebrate and new joys to cherish.",
            "Your kindness makes the world a better place. Never stop being the amazing soul you are.",
            "May this year be filled with adventures, laughter, and moments that take your breath away.",
            "You deserve all the magic life has to offer. May it find its way to you.",
            "Keep shining bright and inspiring everyone around you with your beautiful spirit.",
            "May your journey ahead be as wonderful, unique, and lovely as you are.",
            "Cheers to you, to our bond, and to many more years of shared smiles."
        ];

        let currentWishIndex = 0, isTyping = false, reactionCount = 0;

        // Fireworks
        const fwCanvas = document.getElementById('fireworksCanvas');
        const fwCtx = fwCanvas.getContext('2d');
        fwCanvas.width = window.innerWidth;
        fwCanvas.height = window.innerHeight;
        let fireworks = [];

        class Firework {
            constructor(x, y, color) {
                this.particles = [];
                for (let i = 0; i < 60; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const v = 2 + Math.random() * 6;
                    this.particles.push({
                        x, y, vx: Math.cos(angle) * v, vy: Math.sin(angle) * v,
                        alpha: 1, color, life: 1, decay: 0.008 + Math.random() * 0.012,
                        trail: []
                    });
                }
            }
            update() {
                this.particles.forEach(p => {
                    // Save trail
                    p.trail.push({ x: p.x, y: p.y, alpha: p.alpha * 0.6 });
                    if (p.trail.length > 6) p.trail.shift();
                    p.x += p.vx; p.y += p.vy; p.vy += 0.04;
                    p.vx *= 0.99; p.alpha -= p.decay;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
            }
            draw() {
                this.particles.forEach(p => {
                    // Draw trail
                    p.trail.forEach((t, i) => {
                        fwCtx.globalAlpha = t.alpha * (i / p.trail.length) * 0.5;
                        fwCtx.fillStyle = p.color;
                        fwCtx.beginPath();
                        fwCtx.arc(t.x, t.y, 1.5, 0, Math.PI * 2);
                        fwCtx.fill();
                    });
                    // Draw particle
                    fwCtx.globalAlpha = p.alpha;
                    fwCtx.fillStyle = p.color;
                    fwCtx.beginPath();
                    fwCtx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
                    fwCtx.fill();
                    // Sparkle glow
                    fwCtx.globalAlpha = p.alpha * 0.3;
                    fwCtx.beginPath();
                    fwCtx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                    fwCtx.fill();
                });
            }
        }

        function createFirework(x, y, color) { fireworks.push(new Firework(x, y, color)); }
        function animateFW() {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            fwCtx.globalAlpha = 1;
            fireworks.forEach(fw => { fw.update(); fw.draw(); });
            fireworks = fireworks.filter(fw => fw.particles.length > 0);
            requestAnimationFrame(animateFW);
        }
        animateFW();

        // Music
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicBtn');
        let musicPlaying = false;
        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    musicPlaying = true;
                    musicBtn.classList.add('playing');
                    musicBtn.innerHTML = '<div class="eq-bars"><div class="eq-bar"></div><div class="eq-bar"></div><div class="eq-bar"></div></div>';
                }).catch(e => console.log("Music play failed:", e));
            } else {
                bgMusic.pause();
                musicPlaying = false;
                musicBtn.classList.remove('playing');
                musicBtn.innerHTML = '‚ô´';
            }
        }

        // === Fractal Tree ===
        class FractalTree {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.growth = 0;
                this.bloom = 0;
                this.windAngle = 0;
                this.fallingPetals = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate();
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            updateGrowth(progress) {
                gsap.to(this, { growth: progress, duration: 1.5, ease: "power2.out" });
                if (progress > 0.6) {
                    gsap.to(this, { bloom: Math.min(1, (progress - 0.6) * 2.5), duration: 2, delay: 0.5 });
                }
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.growth <= 0.01) return;

                const len = 130 * Math.min(1, this.canvas.height / 800);
                const w = 14 * Math.min(1, this.canvas.width / 600);
                this.drawBranch(this.canvas.width / 2, this.canvas.height, len * this.growth, -Math.PI / 2, w, 0);
                this.updatePetals();
                this.drawPetals();
            }

            drawBranch(x, y, len, angle, width, depth) {
                const ctx = this.ctx;
                const swayAmp = 0.018 * (depth + 1);
                const sway = Math.sin(Date.now() * 0.0018 + depth * 1.2) * swayAmp;
                const finalAngle = angle + sway;
                const endX = x + len * Math.cos(finalAngle);
                const endY = y + len * Math.sin(finalAngle);

                // Tapered branch (trapezoid)
                const perpX = Math.cos(finalAngle + Math.PI / 2);
                const perpY = Math.sin(finalAngle + Math.PI / 2);
                const tipWidth = width * 0.55;

                // Gradient bark color
                const darkness = Math.max(0, 1 - depth * 0.08);
                const r = Math.round(60 * darkness + 40);
                const g = Math.round(40 * darkness + 25);
                const b = Math.round(20 * darkness + 15);
                ctx.fillStyle = `rgb(${r},${g},${b})`;

                ctx.beginPath();
                ctx.moveTo(x - perpX * width / 2, y - perpY * width / 2);
                ctx.lineTo(x + perpX * width / 2, y + perpY * width / 2);
                ctx.lineTo(endX + perpX * tipWidth / 2, endY + perpY * tipWidth / 2);
                ctx.lineTo(endX - perpX * tipWidth / 2, endY - perpY * tipWidth / 2);
                ctx.closePath();
                ctx.fill();

                if (depth < 10) {
                    const newWidth = width * 0.68;
                    const newLen = len * 0.74;
                    const leftA = 0.3 + Math.sin(this.windAngle * 0.5 + depth) * 0.05;
                    const rightA = 0.35 + Math.cos(this.windAngle * 0.3 + depth) * 0.05;

                    if (newWidth > 0.4) {
                        this.drawBranch(endX, endY, newLen, finalAngle - leftA, newWidth, depth + 1);
                        this.drawBranch(endX, endY, newLen, finalAngle + rightA, newWidth, depth + 1);
                        if (depth === 2 || depth === 5) {
                            this.drawBranch(endX, endY, newLen * 0.6, finalAngle + (this.windAngle % 0.1), newWidth * 0.8, depth + 1);
                        }
                    }

                    if (depth > 6 && this.bloom > 0) {
                        this.drawLeaf(endX, endY, depth, finalAngle);
                    }
                }
            }

            drawLeaf(x, y, depth, angle) {
                const s = this.bloom * (1 + Math.sin(x * 0.1) * 0.2);
                if (s <= 0) return;
                const ctx = this.ctx;
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);

                // Leaf with glow
                ctx.shadowColor = 'rgba(129,199,132,0.4)';
                ctx.shadowBlur = 8 * this.bloom;
                ctx.fillStyle = `rgba(129, 199, 132, ${0.8 * this.bloom})`;
                ctx.beginPath();
                ctx.ellipse(0, 0, 6 * s, 3 * s, Math.PI / 4, 0, Math.PI * 2);
                ctx.fill();

                const isFlower = (depth % 2 !== 0) || (Math.floor(x) % 3 === 0);
                if (this.bloom > 0.4 && isFlower) {
                    const fs = Math.max(0, (this.bloom - 0.4) * 1.6);
                    ctx.shadowColor = 'rgba(248,187,208,0.5)';
                    ctx.shadowBlur = 10 * fs;
                    const color = (Math.floor(x) % 2 === 0) ? `rgba(248,187,208,${fs})` : `rgba(255,255,255,${fs})`;
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(3, -3, 3.5 * fs, 0, Math.PI * 2);
                    ctx.fill();

                    // Occasionally spawn falling petals
                    if (Math.random() < 0.001 && this.fallingPetals.length < 30) {
                        this.fallingPetals.push({
                            x: x, y: y, vx: (Math.random() - 0.5) * 0.8,
                            vy: 0.5 + Math.random(), rot: Math.random() * Math.PI * 2,
                            rotSpeed: (Math.random() - 0.5) * 0.05, alpha: 1,
                            color: (Math.random() > 0.5) ? 'rgba(248,187,208,' : 'rgba(255,255,255,'
                        });
                    }
                }
                ctx.restore();
            }

            updatePetals() {
                this.fallingPetals.forEach(p => {
                    p.x += p.vx + Math.sin(Date.now() * 0.002 + p.rot) * 0.3;
                    p.y += p.vy;
                    p.rot += p.rotSpeed;
                    p.alpha -= 0.003;
                });
                this.fallingPetals = this.fallingPetals.filter(p => p.alpha > 0 && p.y < this.canvas.height);
            }

            drawPetals() {
                const ctx = this.ctx;
                this.fallingPetals.forEach(p => {
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot);
                    ctx.fillStyle = p.color + p.alpha + ')';
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 4, 2.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                });
            }

            animate() {
                this.windAngle += 0.02;
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        const tree = new FractalTree('treeCanvas');

        function growTree() {
            const progress = (reactionCount + 0.5) / wishes.length;
            tree.updateGrowth(Math.min(1, progress));
        }

        // === Wish Creation ===
        function createWishElement(index, text, color) {
            const div = document.createElement('div');
            div.className = 'wish-item';
            div.style.setProperty('--wish-color', color);
            div.innerHTML = `
                <div class="wish-number">WISH ${index + 1}</div>
                <div class="wish-text" id="wish-${index}"></div>
                <div class="wish-author">‚Äî A friend</div>
                <div class="reaction-container">
                    <button class="reaction-btn" onclick="handleReaction(this, '${color}', ${index})">
                        <span>‚ù§</span>
                    </button>
                </div>
            `;
            return div;
        }

        // Floating hearts burst on reaction
        function emitHeartBurst(x, y) {
            const emojis = ['‚ù§Ô∏è', 'üíñ', 'üíó', '‚ú®', 'üíï'];
            for (let i = 0; i < 8; i++) {
                const h = document.createElement('div');
                h.className = 'float-heart';
                h.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                h.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
                h.style.top = y + 'px';
                h.style.animationDelay = (Math.random() * 0.3) + 's';
                h.style.animationDuration = (1 + Math.random()) + 's';
                document.body.appendChild(h);
                setTimeout(() => h.remove(), 2000);
            }
        }

        function handleReaction(btn, color, index) {
            if (btn.classList.contains('liked')) return;
            btn.classList.add('liked');

            const rect = btn.getBoundingClientRect();
            createFirework(rect.left + rect.width / 2, rect.top, color);
            emitHeartBurst(rect.left + rect.width / 2, rect.top);

            reactionCount++;
            growTree();

            setTimeout(() => loadNextWish(), 800);
        }

        async function typeWriter(element, text) {
            return new Promise(resolve => {
                element.classList.add('typing');
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, 25 + Math.random() * 45);
                    } else {
                        element.classList.remove('typing');
                        resolve();
                    }
                }
                type();
            });
        }

        async function loadNextWish() {
            if (currentWishIndex >= wishes.length || isTyping) return;
            isTyping = true;
            const container = document.getElementById('streamContainer');
            const color = wishColors[currentWishIndex % wishColors.length];
            const wishEl = createWishElement(currentWishIndex, wishes[currentWishIndex], color);
            container.appendChild(wishEl);

            await new Promise(r => setTimeout(r, 50));
            wishEl.classList.add('visible');
            wishEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

            const textEl = document.getElementById(`wish-${currentWishIndex}`);
            await typeWriter(textEl, wishes[currentWishIndex]);

            currentWishIndex++;
            isTyping = false;

            document.documentElement.style.setProperty('--current-color', color);
            document.getElementById('progressBar').style.width = (currentWishIndex / wishes.length * 100) + '%';

            if (currentWishIndex === wishes.length) setTimeout(showEnd, 2000);
        }

        // === Confetti ===
        function spawnConfetti() {
            const colors = ['#ff9ff3', '#feca57', '#ff6b6b', '#48dbfb', '#1dd1a1', '#ffd700', '#a29bfe', '#54a0ff'];
            for (let i = 0; i < 60; i++) {
                setTimeout(() => {
                    const c = document.createElement('div');
                    c.className = 'confetti-piece';
                    c.style.left = Math.random() * 100 + '%';
                    c.style.top = '-10px';
                    c.style.background = colors[Math.floor(Math.random() * colors.length)];
                    c.style.animationDelay = (Math.random() * 0.5) + 's';
                    c.style.animationDuration = (2.5 + Math.random() * 2) + 's';
                    c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                    c.style.width = (5 + Math.random() * 6) + 'px';
                    c.style.height = (8 + Math.random() * 8) + 'px';
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 5000);
                }, i * 50);
            }
        }

        function showEnd() {
            const container = document.getElementById('streamContainer');
            const endDiv = document.createElement('div');
            endDiv.className = 'end-message';
            endDiv.innerHTML = `
                <div class="end-card-border">
                    <h2 class="end-title">Happy Birthday, ZaarGull!</h2>
                    <p class="end-subtitle">May your year be as beautiful as this blooming tree.</p>
                </div>
            `;
            container.appendChild(endDiv);
            setTimeout(() => {
                endDiv.classList.add('visible');
                endDiv.scrollIntoView({ behavior: 'smooth' });
                reactionCount = wishes.length;
                growTree();
                spawnConfetti();
                // Grand fireworks
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        createFirework(
                            Math.random() * window.innerWidth,
                            Math.random() * window.innerHeight * 0.5,
                            wishColors[i % wishColors.length]
                        );
                    }, i * 350);
                }
            }, 100);
        }

        function startExperience() {
            // Staggered entrance animation
            const h1 = document.querySelector('.start-screen h1');
            const p = document.querySelector('.start-screen p');
            const btn = document.querySelector('.start-btn');
            gsap.from(h1, { y: 30, opacity: 0, duration: 1, ease: "power3.out" });
            gsap.from(p, { y: 20, opacity: 0, duration: 0.8, delay: 0.3, ease: "power3.out" });
            gsap.from(btn, { y: 20, opacity: 0, duration: 0.8, delay: 0.5, ease: "power3.out" });

            document.getElementById('startScreen').classList.add('hidden');
            toggleMusic();
            loadNextWish();

            const container = document.getElementById('streamContainer');
            container.addEventListener('scroll', () => {
                const scrollPercent = (container.scrollTop + container.clientHeight) / container.scrollHeight;
                if (scrollPercent > 0.7) loadNextWish();
            });
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.reaction-btn') && !e.target.closest('.music-btn')) loadNextWish();
            });
        }
    </script>
</body>

</html>
